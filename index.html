<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JedaBisnis â€” Daftar Layanan Catatan Keuangan</title>
<style>
  :root{
    --bg:#0b0f12; --card:#0f1720; --muted:#9aa6b2; --accent:#6ad3c6; --glass:rgba(255,255,255,0.04);
    --success:#4ade80; --danger:#fb7185; --panel-radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e6eef3;background:linear-gradient(180deg,#071019 0%, #071f24 100%);}
  a{color:inherit}
  .app{
    max-width:1100px;margin:18px auto;padding:16px;
    display:grid;gap:16px;grid-template-columns: 1fr;
  }
  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{width:44px;height:44px;border-radius:8px;object-fit:cover}
  .brand h1{font-size:18px;margin:0}
  .profile {
    display:flex;align-items:center;gap:8px;
  }
  .profile img{width:36px;height:36px;border-radius:50%}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#082426;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
  main{display:grid;gap:14px;grid-template-columns: 1fr;}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,10,0.6);border:1px solid rgba(255,255,255,0.02)}
  form .row{display:flex;gap:8px;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type=text],input[type=email],select,textarea{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:#dbeafe;width:100%}
  textarea{min-height:80px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .center{display:flex;align-items:center;gap:8px}
  .small{font-size:13px;color:var(--muted)}
  .progresswrap{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
  .progressbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .step{flex:1;height:12px;border-radius:999px;background:rgba(255,255,255,0.04);position:relative;overflow:hidden}
  .step .fill{position:absolute;left:0;top:0;bottom:0;width:0%;background:linear-gradient(90deg,var(--accent),#90f2e7)}
  .status-label{font-size:13px;color:var(--muted);margin-top:8px}
  .flex{display:flex;gap:8px;align-items:center}
  table{width:100%;border-collapse:collapse;color:#dbeafe;font-size:14px}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
  .badge{padding:6px 8px;border-radius:10px;font-weight:600}
  .badge.wait{background:rgba(255,255,255,0.03)}
  .badge.ok{background:var(--success);color:#042913}
  .badge.doing{background:#fbbf24;color:#2b1500}
  .badge.finish{background:#7c3aed;color:#fff}
  .admin-controls{display:flex;gap:8px;flex-wrap:wrap}
  .uimg{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .hint{font-size:12px;color:var(--muted)}
  @media(min-width:880px){
    .app{grid-template-columns: 1fr;}
    main{grid-template-columns: 2fr 1fr}
    .two{grid-template-columns:1fr 1fr}
  }
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(2,6,10,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal{background:var(--card);max-width:720px;width:100%;padding:16px;border-radius:12px}
  .modal h3{margin:0 0 8px 0}
  .table-scroll{max-height:340px;overflow:auto}
  .small-icon{width:20px;height:20px;opacity:0.9;border-radius:6px}
  .file-preview{max-width:140px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);padding:6px}
  .disabled{opacity:0.45;pointer-events:none}
  footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
</style>
</head>
<body>
<div class="app">
  <header class="card">
    <div class="brand">
      <img src="https://cdn-icons-png.flaticon.com/512/2921/2921222.png" alt="logo">
      <div>
        <h1>JedaBisnis â€” Catatan Keuangan</h1>
        <div class="small">Daftar layanan & kelola pesanan</div>
      </div>
    </div>
    <div class="profile" id="profileBox">
      <button id="googleSignInInitial" class="btn">Login dengan Google</button>
    </div>
  </header>

  <main>
    <section>
      <div class="card" id="userArea" style="display:none">
        <div style="display:flex;gap:12px;align-items:center">
          <img id="userPhoto" class="uimg" src="" alt="profile">
          <div>
            <div id="userName" style="font-weight:700">Nama</div>
            <div class="small" id="userEmail">email</div>
            <button id="logoutBtn" class="btn ghost" style="margin-top:8px">Logout</button>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)">

        <h3>Form Pendaftaran / Pembelian Layanan</h3>
        <form id="orderForm" class="small" autocomplete="off">
          <div class="row">
            <div style="flex:1">
              <label>Nama Bisnis</label>
              <input id="bizName" type="text" placeholder="Nama usaha / bisnis">
            </div>
            <div style="width:180px">
              <label>No. WA</label>
              <input id="phone" type="text" placeholder="628xxx">
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div style="flex:1">
              <label>Email</label>
              <input id="emailField" type="email" disabled>
            </div>
            <div style="width:200px">
              <label>Kategori Bisnis</label>
              <select id="category">
                <option value="">--Pilih--</option>
                <option>Retail</option>
                <option>Jasa</option>
                <option>F&B</option>
                <option>Digital</option>
                <option>Lainnya</option>
              </select>
            </div>
          </div>

          <div class="two" style="margin-top:8px">
            <div>
              <label>Metode Pembayaran</label>
              <select id="paymentMethod">
                <option value="">--Pilih--</option>
                <option>Transfer Bank</option>
                <option>Dana/OVO/LinkAja</option>
                <option>COD</option>
              </select>
            </div>
            <div>
              <label>Harga Asli (Rp)</label>
              <input id="priceOriginal" type="text" placeholder="100000">
            </div>
          </div>

          <div class="two" style="margin-top:8px">
            <div>
              <label>Harga Diskon (Rp)</label>
              <input id="priceDiscount" type="text" placeholder="80000">
            </div>
            <div>
              <label>Catatan Tambahan</label>
              <input id="note" type="text" placeholder="Permintaan khusus (opsional)">
            </div>
          </div>

          <div style="margin-top:10px">
            <label>Upload Bukti Pembayaran (gambar kecil) <span class="hint">â€” base64 akan disimpan di Realtime DB</span></label>
            <input id="proofFile" type="file" accept="image/*">
            <div id="previewWrap" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="registerBtn" type="button" class="btn disabled">Daftar Sekarang</button>
            <div class="small hint" id="formHint">Semua field wajib terisi kecuali catatan tambahan.</div>
          </div>
        </form>

        <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)">

        <h3>Status Pesanan Anda</h3>
        <div id="noOrder" class="small hint">Belum ada pesanan.</div>
        <div id="orderStatusWrap" style="display:none">
          <div class="progresswrap">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><strong id="orderBizTitle"></strong><div class="small" id="orderIdLabel"></div></div>
              <div><span class="small hint">Harga: Rp <span id="orderPriceDisplay">0</span></span></div>
            </div>

            <div style="margin-top:10px" class="progressbar">
              <div style="flex:1;margin-right:8px">
                <div class="step"><div class="fill" id="fillBar" style="width:0%"></div></div>
                <div class="status-label" id="statusText">Status</div>
              </div>
              <div style="width:120px;text-align:right">
                <span id="statusBadge" class="badge wait">-</span>
              </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px">
              <button id="viewNoteBtn" class="btn ghost" style="display:none">Lihat Info Project</button>
              <div class="small hint" id="adminNotePreview" style="flex:1"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="modalProj" class="modal-back"><div class="modal">
        <h3>Informasi Project</h3>
        <div id="projInfo" class="small"></div>
        <div style="margin-top:12px;text-align:right"><button id="closeModal" class="btn ghost">Tutup</button></div>
      </div></div>

    </section>

    <aside>
      <div class="card" id="summaryCard">
        <h3>Ringkasan & Dashboard</h3>
        <div style="display:flex;justify-content:space-between;gap:8px;margin-top:8px">
          <div>
            <div class="small">Total Pesanan Anda</div>
            <div id="userOrdersCount" style="font-weight:700">0</div>
          </div>
          <div>
            <div class="small">Status Terakhir</div>
            <div id="lastStatus" style="font-weight:700">-</div>
          </div>
        </div>

        <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.02)">

        <div id="adminPanel" style="display:none">
          <h4>Admin Panel</h4>
          <div class="small hint">Hanya untuk admin yang diizinkan.</div>
          <div style="margin-top:8px" id="adminControls">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <button id="refreshOrders" class="btn ghost">Segarkan</button>
            </div>
            <div class="table-scroll" id="ordersTableWrap"></div>
          </div>
        </div>

        <div id="userList" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4>Info singkat</h4>
        <div class="small">
          - Sistem menyimpan bukti pembayaran sebagai data URL (base64) di Realtime Database.<br>
          - Admin bisa mengubah status: <strong>waiting â†’ confirmed â†’ doing â†’ finished</strong> dan menambahkan catatan saat selesai.
        </div>
      </div>
    </aside>
  </main>

  <footer>Â© JedaBisnis â€” Catatan Keuangan</footer>
</div>

<script type="module">
  // --------- CONFIG: ganti ini dengan config project Firebase-mu ----------
const firebaseConfig = {
  apiKey: "AIzaSyD_4hkC5918dHoQEOqyZ7FHR02eHx25rzM",
  authDomain: "register-7883a.firebaseapp.com",
  projectId: "register-7883a",
  storageBucket: "register-7883a.firebasestorage.app",
  messagingSenderId: "900344098901",
  appId: "1:900344098901:web:b95b608dacbac8285964dc",
  measurementId: "G-L3CGV1P69Y"
};
  // ----------------- END CONFIG ----------------------------------------

  // Admin emails yang boleh akses dashboard admin:
  const ADMIN_EMAILS = ['shysondiamond@gmail.com']; // <-- ganti dengan email admin sebenarnya

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";
  import { getDatabase, ref, set, push, onValue, update, get, child, remove } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-database.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();
  const db = getDatabase(app);

  // UI elems
  // Menggunakan googleSignInInitial untuk tombol yang ada di HTML statis
  const googleSignInInitial = document.getElementById('googleSignInInitial'); 
  const profileBox = document.getElementById('profileBox');
  const userArea = document.getElementById('userArea');
  const userPhoto = document.getElementById('userPhoto');
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const emailField = document.getElementById('emailField');
  const registerBtn = document.getElementById('registerBtn');
  const proofFile = document.getElementById('proofFile');
  const previewWrap = document.getElementById('previewWrap');
  const noOrder = document.getElementById('noOrder');
  const orderStatusWrap = document.getElementById('orderStatusWrap');
  const fillBar = document.getElementById('fillBar');
  const statusText = document.getElementById('statusText');
  const statusBadge = document.getElementById('statusBadge');
  const orderBizTitle = document.getElementById('orderBizTitle');
  const orderIdLabel = document.getElementById('orderIdLabel');
  const orderPriceDisplay = document.getElementById('orderPriceDisplay');
  const userOrdersCount = document.getElementById('userOrdersCount');
  const lastStatus = document.getElementById('lastStatus');
  const adminPanel = document.getElementById('adminPanel');
  const ordersTableWrap = document.getElementById('ordersTableWrap');
  const refreshOrders = document.getElementById('refreshOrders');
  const viewNoteBtn = document.getElementById('viewNoteBtn');
  const projInfo = document.getElementById('projInfo');
  const modalProj = document.getElementById('modalProj');
  const closeModal = document.getElementById('closeModal');
  const adminNotePreview = document.getElementById('adminNotePreview');
  const orderForm = document.getElementById('orderForm');

  let currentUser = null;
  let proofDataUrl = null;
  let myLatestOrderId = null;

  // util: enable/disable register button
  function updateRegisterState(){
    const requiredFields = ['bizName', 'phone', 'category', 'paymentMethod', 'priceOriginal', 'priceDiscount'];
    const allFieldsFilled = requiredFields.every(id => document.getElementById(id).value.trim());

    if(allFieldsFilled && proofDataUrl){
      registerBtn.classList.remove('disabled');
      registerBtn.disabled = false;
    } else {
      registerBtn.classList.add('disabled');
      registerBtn.disabled = true;
    }
  }

  // file -> dataURL
  proofFile.addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    if(f.size > 1024*1024*2){ // 2MB limit warning
      alert('Ukuran file besar. Disarankan < 2MB agar database tidak berat.');
    }
    const reader = new FileReader();
    reader.onload = ()=> {
      proofDataUrl = reader.result;
      previewWrap.innerHTML = '<img class="file-preview" src="'+proofDataUrl+'">';
      updateRegisterState();
    };
    reader.readAsDataURL(f);
  });

  // Fungsi Sign in
  async function handleSignIn() {
      try{
        await signInWithPopup(auth, provider);
      }catch(err){ console.error(err); alert('Gagal login: '+err.message) }
  }

  // ðŸ“Œ Perbaikan Login: Pasang listener ke tombol statis
  if (googleSignInInitial) {
    googleSignInInitial.addEventListener('click', handleSignIn);
  }

  logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
  });

 // ... (Bagian UI elems tetap sama)

// Fungsi Sign in
async function handleSignIn() {
    try{
        await signInWithPopup(auth, provider);
    }catch(err){ 
        console.error("FIREBASE SIGN IN ERROR:", err); 
        alert('Gagal login: '+err.message); 
    }
}

// HAPUS event listener ini dari awal, karena tombol ini akan segera ditimpa:
// if (googleSignInInitial) {
//   googleSignInInitial.addEventListener('click', handleSignIn);
// }

logoutBtn.addEventListener('click', async ()=>{
    await signOut(auth);
});

// Listen auth changes
onAuthStateChanged(auth, async user=>{
    currentUser = user;
    
    // 1. Kosongkan profileBox terlebih dahulu untuk mempersiapkan tampilan
    profileBox.innerHTML = '';

    if(user){
        // --- KETIKA USER LOGIN ---
        
        userArea.style.display = 'block';
        userPhoto.src = user.photoURL || 'https://via.placeholder.com/120';
        userName.textContent = user.displayName || 'User';
        userEmail.textContent = user.email || '';
        emailField.value = user.email || '';

        // Tampilkan info profile kecil di header
        profileBox.innerHTML = `
            <img src="${user.photoURL||''}" alt="p" style="width:36px;height:36px;border-radius:50%">
            <div style="display:flex;flex-direction:column;align-items:flex-end">
                <div style="font-weight:700">${user.displayName||''}</div>
                <button id="logoutSmall" class="btn ghost" style="margin-top:4px">Logout</button>
            </div>`;
        
        // Pasang listener untuk tombol logout kecil yang BARU dibuat
        const logoutSmall = document.getElementById('logoutSmall');
        if (logoutSmall) logoutSmall.addEventListener('click', ()=> signOut(auth));

        // Admin checks
        if(ADMIN_EMAILS.includes(user.email)){
            adminPanel.style.display = 'block';
            loadAllOrders();
        } else {
            adminPanel.style.display = 'none';
        }
        
        watchUserOrders(user.uid);
        
    } else {
        // --- KETIKA USER LOGGED OUT / HALAMAN DIMUAT PERTAMA KALI ---
        
        userArea.style.display = 'none';
        
        // Buat TOMBOL LOGIN BARU di dalam profileBox
        profileBox.innerHTML = '<button id="googleSignInNew" class="btn">Login dengan Google</button>';
        
        // Cari tombol yang BARU dibuat dan pasang listener-nya
        const googleSignInNew = document.getElementById('googleSignInNew');
        if (googleSignInNew) {
            googleSignInNew.addEventListener('click', handleSignIn);
        }
    }
});

  // Register / create order
  registerBtn.addEventListener('click', async ()=>{
    if(!currentUser){ alert('Silakan login terlebih dahulu'); return; }
    updateRegisterState(); // Re-check validation
    if(registerBtn.disabled) return;
    registerBtn.textContent = 'Mencatat...'; registerBtn.disabled = true;
    
    // ... data order
    const order = {
      uid: currentUser.uid,
      userName: currentUser.displayName || '',
      userEmail: currentUser.email || '',
      userPhoto: currentUser.photoURL || '',
      bizName: document.getElementById('bizName').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      category: document.getElementById('category').value,
      paymentMethod: document.getElementById('paymentMethod').value,
      priceOriginal: document.getElementById('priceOriginal').value.trim(),
      priceDiscount: document.getElementById('priceDiscount').value.trim(),
      note: document.getElementById('note').value.trim() || '',
      proofBase64: proofDataUrl || '',
      createdAt: Date.now(),
      status: 'waiting', // waiting -> confirmed -> doing -> finished
      adminNote: '',
      progressUpdatedAt: Date.now()
    };
    
    try{
      const ordersRef = ref(db, 'orders');
      const newRef = push(ordersRef);
      await set(newRef, order);
      myLatestOrderId = newRef.key;
      alert('Pesanan terkirim. Tunggu konfirmasi admin.');
      loadMyLatestOrder(currentUser.uid);
    }catch(err){
      console.error(err);
      alert('Gagal menyimpan pesanan: '+err.message);
    } finally {
      registerBtn.textContent = 'Daftar Sekarang';
      updateRegisterState();
    }
  });

  // Watch user's orders: count & get latest
  function watchUserOrders(uid){
    const ordersRef = ref(db, 'orders');
    onValue(ordersRef, snapshot=>{
      const val = snapshot.val() || {};
      const arr = Object.entries(val).map(([k,v])=>({id:k,...v})).filter(o=> o.uid === uid).sort((a,b)=> b.createdAt - a.createdAt);
      userOrdersCount.textContent = arr.length;
      if(arr.length>0){
        const latest = arr[0];
        myLatestOrderId = latest.id;
        populateOrderStatus(latest);
        noOrder.style.display = 'none';
        orderStatusWrap.style.display = 'block';
        lastStatus.textContent = latest.status;
      } else {
        myLatestOrderId = null;
        noOrder.style.display = 'block';
        orderStatusWrap.style.display = 'none';
        lastStatus.textContent = '-';
      }
    });
  }

  // Show order status UI based on status
  function populateOrderStatus(order){
    orderBizTitle.textContent = order.bizName + ' â€¢ ' + (order.userName || '');
    orderIdLabel.textContent = 'ID: ' + (order.id || order.id) + ' â€¢ Dibuat: ' + new Date(order.createdAt).toLocaleString();
    orderPriceDisplay.textContent = order.priceDiscount || order.priceOriginal || '0';
    statusText.textContent = mapStatusText(order.status);
    statusBadge.className = 'badge';
    adminNotePreview.textContent = order.adminNote ? 'Admin: ' + (order.adminNote.length>80 ? order.adminNote.slice(0,80)+'...' : order.adminNote) : '';
    if(order.adminNote){
      viewNoteBtn.style.display = 'inline-block';
      viewNoteBtn.onclick = ()=> {
        projInfo.innerHTML = '<div class="small">'+escapeHtml(order.adminNote).replace(/\n/g,'<br>')+'</div>';
        modalProj.style.display = 'flex';
      };
    } else {
      viewNoteBtn.style.display = 'none';
    }
    // fillbar % mapping
    const map = { 'waiting':10, 'confirmed':45, 'doing':75, 'finished':100 };
    const colors = { 'waiting':'wait','confirmed':'ok','doing':'doing','finished':'finish' };
    fillBar.style.width = (map[order.status]||0)+'%';
    statusBadge.textContent = order.status;
    statusBadge.classList.add(colors[order.status]||'wait');
  }

  function mapStatusText(s){
    switch(s){
      case 'waiting': return 'Menunggu Konfirmasi Admin';
      case 'confirmed': return 'Terkonfirmasi';
      case 'doing': return 'Project sedang dibuat (estimasi 24 jam)';
      case 'finished': return 'Project Selesai';
      default: return s;
    }
  }

  // Load my latest order once (helper)
  async function loadMyLatestOrder(uid){
    const dbRef = ref(db);
    const snap = await get(child(dbRef, 'orders'));
    const val = snap.val() || {};
    const arr = Object.entries(val).map(([k,v])=>({id:k,...v})).filter(o=> o.uid === uid).sort((a,b)=> b.createdAt - a.createdAt);
    if(arr.length>0){
      populateOrderStatus(arr[0]);
    }
  }

  // ADMIN: load all orders
  async function loadAllOrders(){
    ordersTableWrap.innerHTML = '<div class="small hint">Memuat daftar...</div>';
    const ordersRef = ref(db, 'orders');
    onValue(ordersRef, snapshot=>{
      const val = snapshot.val() || {};
      const arr = Object.entries(val).map(([k,v])=>({id:k,...v})).sort((a,b)=> b.createdAt - a.createdAt);
      renderAdminTable(arr);
    });
  }

  // ðŸ“Œ Menggunakan handleAdminAction untuk mengelola semua aksi admin
  function renderAdminTable(arr){
    if(arr.length===0) { ordersTableWrap.innerHTML = '<div class="small hint">Belum ada pesanan.</div>'; return; }
    let html = '<table><thead><tr><th>Waktu</th><th>Nama / Bisnis</th><th>Email</th><th>Harga</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
    arr.forEach(o=>{
      html += `<tr>
        <td>${new Date(o.createdAt).toLocaleString()}</td>
        <td><div style="display:flex;gap:8px;align-items:center"><img class="small-icon" src="${o.userPhoto||''}" /><div><strong>${escapeHtml(o.userName||'')}</strong><div class="small">${escapeHtml(o.bizName||'')}</div></div></div></td>
        <td>${escapeHtml(o.userEmail||'')}</td>
        <td>Rp ${escapeHtml(o.priceDiscount||o.priceOriginal||'0')}</td>
        <td><span class="badge ${o.status}">${o.status}</span></td>
        <td>
          <div class="admin-controls">
            <button class="btn ghost" data-id="${o.id}" data-status="confirmed" onclick="handleAdminAction(this)">Confirm</button>
            <button class="btn ghost" data-id="${o.id}" data-status="doing" onclick="handleAdminAction(this)">Start</button>
            <button class="btn ghost" data-id="${o.id}" data-status="finished" onclick="handleAdminAction(this)">Finish</button>
            <button class="btn ghost" data-id="${o.id}" data-action="view" onclick="handleAdminAction(this)">Lihat</button>
            <button class="btn ghost" data-id="${o.id}" data-action="delete" onclick="handleAdminAction(this)">Hapus</button>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    ordersTableWrap.innerHTML = html;
  }

  // expose functions to window for button onclick handlers inside generated HTML
  window.handleAdminAction = async function(el) {
      const orderId = el.getAttribute('data-id');
      const newStatus = el.getAttribute('data-status');
      const action = el.getAttribute('data-action');

      if (action === 'view') {
          await viewOrderDetail(orderId);
      } else if (action === 'delete') {
          await deleteOrder(orderId);
      } else if (newStatus) {
          await changeStatus(orderId, newStatus);
      }
  };
  
  // Fungsi dipindahkan ke lingkup non-window, hanya `handleAdminAction` yang diekspos
  async function changeStatus(orderId, newStatus){
    if(!confirm('Ubah status ke "'+newStatus+'"?')) return;
    const orderRef = ref(db, 'orders/' + orderId);
    await update(orderRef, { status: newStatus, progressUpdatedAt: Date.now() });
    
    if(newStatus === 'finished'){
      const adminNote = prompt('Tulis informasi / catatan project (akan tampil ke user):', '');
      if(adminNote!==null){
        await update(orderRef, { adminNote: adminNote });
      }
    }
    alert('Status diperbarui.');
  }

  async function viewOrderDetail(orderId){
    const snap = await get(ref(db, 'orders/' + orderId));
    const o = snap.val();
    if(!o) return alert('Tidak ditemukan.');
    
    let msg = `<div class="small"><strong>${escapeHtml(o.userName||'')}</strong> (${escapeHtml(o.userEmail||'')})<br/>Bisnis: ${escapeHtml(o.bizName||'')}<br/>No WA: ${escapeHtml(o.phone||'')}<br/>Kategori: ${escapeHtml(o.category||'')}<br/>Metode: ${escapeHtml(o.paymentMethod||'')}<br/>Harga: Rp ${escapeHtml(o.priceDiscount||o.priceOriginal||'0')}<br/>Status: ${escapeHtml(o.status||'')}<br/>Catatan Admin: ${escapeHtml(o.adminNote||'-')}</div>`;
    if(o.proofBase64){
      msg += '<div style="margin-top:8px"><img class="file-preview" src="'+o.proofBase64+'"></div>';
    }
    modalProj.style.display = 'flex';
    projInfo.innerHTML = msg;
  }

  async function deleteOrder(orderId){
    if(!confirm('Hapus pesanan ini? Tindakan tidak bisa dibatalkan.')) return;
    await remove(ref(db, 'orders/' + orderId));
    alert('Terhapus.');
  }

  // helper escape
  function escapeHtml(s){
    if(!s && s!==0) return '';
    return String(s).replace(/[&<>"'`]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[m]; });
  }

  // close modal
  closeModal.addEventListener('click', ()=> modalProj.style.display = 'none');
  modalProj.addEventListener('click', (e)=>{ if(e.target === modalProj) modalProj.style.display = 'none'; });

  // refresh admin
  refreshOrders.addEventListener('click', ()=> loadAllOrders());

  // form inputs trigger validation
  ['bizName','phone','category','paymentMethod','priceOriginal','priceDiscount'].forEach(id=>{
    document.getElementById(id).addEventListener('input', updateRegisterState);
  });

  // small helper to watch single order change (if admin updates finished note)
  onValue(ref(db, 'orders'), snapshot=>{
    if(currentUser && myLatestOrderId){
      const val = snapshot.val() || {};
      const order = val[myLatestOrderId];
      if(order){
        populateOrderStatus(order);
      }
    }
  });

  // initial safety: prevent accidental page unload during outgoing submit
  window.addEventListener('beforeunload', function (e) {
    if(registerBtn && registerBtn.disabled && registerBtn.textContent.includes('Mencatat')) {
      e.preventDefault(); e.returnValue = '';
    }
  });

  // small accessibility: ensure register button state correct on load
  updateRegisterState();

  // end module
</script>
</body>
</html>
